<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoU OCR Service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .preview-img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }
        .result-card {
            margin-bottom: 20px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Custom styles for file preview */
        .file-preview-item {
            position: relative;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .file-preview-item .file-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }
        .file-preview-item .remove-btn {
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1;
        }
        .file-preview-item .remove-btn:hover {
            color: #bb2d3b;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <h1 class="mb-4 text-center">OCR & Table Recognition Service</h1>
    
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">Configuration</div>
                <div class="card-body">
                    <form id="configForm">
                        <div class="mb-3">
                            <label class="form-label">Model Selection</label>
                            <select class="form-select" id="modelSelect">
                                <option value="Table" selected>Table (Wired Table)</option>
                                <option value="Hunyuanocr">HunyuanOCR (Pure Text)</option>
                                <option value="NoTable">NoTable (Lineless Table)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Prompt</label>
                            <textarea class="form-control" id="promptInput" rows="4">检测并识别图片中的文字，输出每段文本的坐标。特别注意表格内容，如果同一个单元格内的文字分多行显示，请务必将其合并为单行文本输出，不要分开。例如单元格内第一行是'ABC'，第二行是'D'，应直接输出'ABCD'。以JSON数组形式返回，每个元素包含text与bbox，bbox为[x1,y1,x2,y2]，坐标单位为像素，禁止返回非JSON内容。</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">IoU Threshold</label>
                            <input type="number" class="form-control" id="iouInput" value="0.8" step="0.05" min="0" max="1">
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>File Upload</span>
                    <button class="btn btn-danger btn-sm" id="clearAllBtn">Clear All History</button>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="mb-3">
                        <label for="fileInput" class="form-label visually-hidden">Select Files</label>
                        <input type="file" class="form-control" id="fileInput" multiple accept=".jpg,.jpeg,.png,.pdf,.doc,.docx">
                        <div class="form-text mt-2" id="fileCountText">未选择文件</div>
                    </div>
                    
                    <!-- File Preview Area -->
                    <div id="filePreviewArea" class="flex-grow-1 border rounded p-2 mb-3 overflow-auto" style="max-height: 300px; min-height: 150px; background-color: #f8f9fa;">
                        <p class="text-muted text-center mt-5" id="emptyPreviewText">No files selected</p>
                        <!-- Preview items will be added here -->
                    </div>

                    <button class="btn btn-primary w-100 mt-auto" id="uploadBtn">Start Processing</button>
                </div>
            </div>
        </div>
    </div>

    <div id="resultsArea"></div>
    
    <!-- Color Legend -->
    <div class="fixed-bottom p-3 bg-light border-top" id="legendBar">
        <div class="container d-flex justify-content-center align-items-center gap-4 position-relative">
            <strong>图例说明：</strong>
            <div class="d-flex align-items-center gap-2">
                <div style="width: 20px; height: 20px; border: 2px solid #00ff00; background: rgba(0,255,0,0.1);"></div>
                <span>经过 IoU 合并后的结果 (Table Cell)</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <div style="width: 20px; height: 20px; border: 2px solid #0000ff; background: rgba(0,0,255,0.1);"></div>
                <span>表格框线 (Text)</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <div style="width: 20px; height: 20px; border: 1px solid #ff0000;"></div>
                <span>HunyuanOCR识别 (Structure)</span>
            </div>
            <button type="button" class="btn-close position-absolute end-0" aria-label="Close" onclick="document.getElementById('legendBar').style.display='none'"></button>
        </div>
    </div>
</div>

<!-- WebSocket Script Integration -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_BASE = window.location.origin;
    // For WebSocket, use ws:// or wss:// based on current protocol
    const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    // Use location.hostname if host is not working or if running behind proxy/port forwarding
    // But window.location.host includes port, which is correct.
    const WS_URL = `${WS_PROTOCOL}//${window.location.host}/ws`;

    let socket;

    function connectWebSocket() {
        socket = new WebSocket(WS_URL);
        
        socket.onopen = () => {
            console.log("WebSocket Connected");
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            handleWSMessage(data);
        };

        socket.onclose = () => {
            console.log("WebSocket Disconnected. Reconnecting in 3s...");
            setTimeout(connectWebSocket, 3000);
        };
    }

    // Connect immediately
    connectWebSocket();

    // File Management Logic
    let selectedFiles = []; // Array to store File objects

    const fileInput = document.getElementById('fileInput');
    const filePreviewArea = document.getElementById('filePreviewArea');
    const emptyPreviewText = document.getElementById('emptyPreviewText');
    const fileCountText = document.getElementById('fileCountText');

    fileInput.addEventListener('change', (e) => {
        const newFiles = Array.from(e.target.files);
        if (newFiles.length > 0) {
            // Add new files to our array
            selectedFiles = [...selectedFiles, ...newFiles];
            updateFilePreview();
        }
        // Reset input so change event fires even if same files selected again
        // And also clears the text "3 files selected" from the input visually
        fileInput.value = ''; 
    });

    function updateFilePreview() {
        // Clear current list except empty text
        filePreviewArea.innerHTML = '';
        
        if (selectedFiles.length === 0) {
            filePreviewArea.appendChild(emptyPreviewText);
            emptyPreviewText.style.display = 'block';
            fileCountText.textContent = '未选择文件';
        } else {
            emptyPreviewText.style.display = 'none'; // Keep it but hidden or just recreate
            fileCountText.textContent = `已选择 ${selectedFiles.length} 个文件`;
            
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                item.innerHTML = `
                    <span class="file-name" title="${file.name}">${file.name}</span>
                    <span class="remove-btn" onclick="removeFile(${index})">&times;</span>
                `;
                filePreviewArea.appendChild(item);
            });
        }
    }

    window.removeFile = (index) => {
        selectedFiles.splice(index, 1);
        updateFilePreview();
    };

    function handleWSMessage(data) {
        const { type, file_id, message, current, total, result } = data;
        
        // Find or create card for this file
        let card = document.getElementById(`card-${file_id}`);
        
        // If "log" or "progress", we might need a card placeholder if not exists
        // But usually we create placeholders immediately after upload API returns.
        // Let's rely on upload API response to create initial cards, 
        // OR create them dynamically here if missing.
        
        if (!card) {
            // Wait, we usually create cards after upload response. 
            // But async events might come fast.
            // If card doesn't exist, we can't show progress easily unless we create a temp one.
            // Let's assume createPlaceholder is called by upload response.
            return; 
        }

        const progressBar = card.querySelector('.progress-bar');
        const statusText = card.querySelector('.status-text');
        const cardBody = card.querySelector('.card-body');

        if (type === 'log') {
            statusText.textContent = message;
        } else if (type === 'progress') {
            const percent = Math.round((current / total) * 100);
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${percent}%`;
                progressBar.setAttribute('aria-valuenow', percent);
            }
            statusText.textContent = message; // "Processing page X/Y..."
        } else if (type === 'complete') {
            // Update card with results
            if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.className = 'progress-bar bg-success';
                progressBar.textContent = 'Completed';
            }
            statusText.textContent = 'Processing Completed.';
            
            // Render results
            renderResults(cardBody, result);
            
            // Update header with buttons
            const headerActions = card.querySelector('.header-actions');
            headerActions.innerHTML = `
                <a href="${API_BASE}${result.json_url}" download class="btn btn-success btn-sm me-2">Download JSON</a>
                <button class="btn btn-danger btn-sm" onclick="deleteFile('${result.file_id}')">Delete</button>
            `;
        } else if (type === 'error') {
             if (progressBar) {
                progressBar.className = 'progress-bar bg-danger';
                progressBar.style.width = '100%';
                progressBar.textContent = 'Error';
            }
            statusText.textContent = `Error: ${message}`;
            statusText.className = 'status-text text-danger';
        }
    }

    function renderResults(container, result) {
        let pagesHtml = '';
        result.pages.forEach(page => {
            // Convert page results object to formatted JSON string
            // We need to find the corresponding result for this page
            // Actually result.json_url points to the FULL file result.
            // But here we might want per-page JSON or just display the full JSON on the side?
            // The requirement is: split screen, left image, right JSON.
            // Let's assume we display the full file JSON or per-page JSON. 
            // Since the result object passed here contains metadata, we might need to fetch the JSON content.
            // Or we can just use the `result` object if it had the data. 
            // Currently `result` has `pages` list with `vis_url`.
            // We need to fetch the JSON to display it.
            
            pagesHtml += `
                <div class="row mb-4 border-bottom pb-3 align-items-stretch">
                    <div class="col-md-6">
                        <h6>Page ${page.page_num} - Image</h6>
                        <a href="${API_BASE}${page.vis_url}" target="_blank">
                            <img src="${API_BASE}${page.vis_url}" class="preview-img" alt="Page ${page.page_num}">
                        </a>
                    </div>
                    <div class="col-md-6 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="format-${result.file_id}-${page.page_num}" id="btn-json-${result.file_id}-${page.page_num}" autocomplete="off" checked onchange="toggleFormat('${result.file_id}-${page.page_num}', 'json')">
                                <label class="btn btn-outline-primary btn-sm" for="btn-json-${result.file_id}-${page.page_num}">JSON</label>

                                <input type="radio" class="btn-check" name="format-${result.file_id}-${page.page_num}" id="btn-md-${result.file_id}-${page.page_num}" autocomplete="off" onchange="toggleFormat('${result.file_id}-${page.page_num}', 'md')">
                                <label class="btn btn-outline-primary btn-sm" for="btn-md-${result.file_id}-${page.page_num}">Markdown</label>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyContent('${result.file_id}-${page.page_num}')">Copy</button>
                        </div>
                        <div class="position-relative flex-grow-1">
                            <textarea class="form-control bg-light h-100" id="json-content-${result.file_id}-${page.page_num}" style="resize: none; min-height: 300px;" readonly>Loading JSON...</textarea>
                            <textarea class="form-control bg-light h-100 d-none" id="md-content-${result.file_id}-${page.page_num}" style="resize: none; min-height: 300px;" readonly>Loading Markdown...</textarea>
                        </div>
                    </div>
                </div>
            `;
            
            // Trigger JSON fetch for this file
            fetchJsonContent(result.json_url, result.file_id, page.page_num);
        });
        
        const resultContainer = document.createElement('div');
        resultContainer.className = 'mt-3';
        resultContainer.innerHTML = pagesHtml;
        container.appendChild(resultContainer);
    }

    async function fetchJsonContent(url, fileId, pageNum) {
        try {
            const response = await fetch(`${API_BASE}${url}`);
            const data = await response.json();
            
            // Find data for specific page
            const pageData = data.find(p => p.page === pageNum);
            const results = pageData ? pageData.results : [];
            
            const jsonStr = JSON.stringify(results, null, 2);
            // Simple Markdown generation: just join text with newlines
            // If bbox represents structure, a more complex parser is needed.
            // For now, assuming paragraphs.
            const mdStr = results.map(item => item.text).join('\n\n');
            
            const jsonTextarea = document.getElementById(`json-content-${fileId}-${pageNum}`);
            if (jsonTextarea) {
                jsonTextarea.value = jsonStr;
            }
            
            const mdTextarea = document.getElementById(`md-content-${fileId}-${pageNum}`);
            if (mdTextarea) {
                mdTextarea.value = mdStr;
            }

        } catch (e) {
            console.error("Failed to fetch JSON:", e);
            const jsonTextarea = document.getElementById(`json-content-${fileId}-${pageNum}`);
            if (jsonTextarea) jsonTextarea.value = "Error loading JSON.";
        }
    }

    window.toggleFormat = (idBase, format) => {
        const jsonEl = document.getElementById(`json-content-${idBase}`);
        const mdEl = document.getElementById(`md-content-${idBase}`);
        
        if (format === 'json') {
            jsonEl.classList.remove('d-none');
            mdEl.classList.add('d-none');
        } else {
            jsonEl.classList.add('d-none');
            mdEl.classList.remove('d-none');
        }
    };

    window.copyContent = (idBase) => {
        // Determine which one is visible
        const jsonEl = document.getElementById(`json-content-${idBase}`);
        const mdEl = document.getElementById(`md-content-${idBase}`);
        
        let targetEl = jsonEl;
        if (jsonEl.classList.contains('d-none')) {
            targetEl = mdEl;
        }
        
        targetEl.select();
        try {
            navigator.clipboard.writeText(targetEl.value).then(() => {
                alert("Content copied to clipboard!");
            });
        } catch (e) {
            document.execCommand('copy');
            alert("Content copied!");
        }
    };

    document.getElementById('uploadBtn').addEventListener('click', async () => {
        // Use selectedFiles instead of fileInput.files
        if (selectedFiles.length === 0) {
            alert("Please select files first.");
            return;
        }

        const formData = new FormData();
        for (let i = 0; i < selectedFiles.length; i++) {
            formData.append('files', selectedFiles[i]);
        }
        
        formData.append('mode', document.getElementById('modelSelect').value);
        formData.append('prompt', document.getElementById('promptInput').value);
        formData.append('iou_threshold', document.getElementById('iouInput').value);

        // Don't show global loading overlay, use inline progress cards
        // showLoading(true); 
        
        try {
            const response = await fetch(`${API_BASE}/upload`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if (data.status === "processing_started") {
                // Create placeholders for files
                data.files.forEach(file => createPlaceholderCard(file));
                
                // Clear selection after successful upload start
                selectedFiles = [];
                updateFilePreview();
            } else {
                alert(data.message || "Upload failed");
            }
            
        } catch (error) {
            console.error("Error:", error);
            alert("Upload failed.");
        } finally {
            fileInput.value = ''; // Reset
        }
    });

    function createPlaceholderCard(file) {
        const container = document.getElementById('resultsArea');
        const html = `
            <div class="card result-card" id="card-${file.file_id}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>${file.filename}</strong>
                    <div class="header-actions">
                        <span class="badge bg-secondary">Processing...</span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="status-text mb-2">Initializing...</p>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('afterbegin', html);
    }

    document.getElementById('clearAllBtn').addEventListener('click', async () => {
        if (!confirm("Are you sure you want to delete all files and results?")) return;
        try {
            await fetch(`${API_BASE}/clear`, { method: 'DELETE' });
            document.getElementById('resultsArea').innerHTML = '';
        } catch (error) {
            console.error("Error:", error);
        }
    });

    window.deleteFile = async (fileId) => {
        if (!confirm("Delete this result?")) return;
        try {
            await fetch(`${API_BASE}/delete/${fileId}`, { method: 'DELETE' });
            const card = document.getElementById(`card-${fileId}`);
            if (card) card.remove();
        } catch (error) {
            console.error("Error:", error);
        }
    };
</script>

</body>
</html>
